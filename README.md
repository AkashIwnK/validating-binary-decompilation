# validating-binary-decompilation
![](https://github.com/sdasgup3/validating-binary-decompilation/blob/master/docs/misc/overview_diag.png)

The project is about validating the correctness of "binary lifters", which
translate binary code into an IR format. Specifically, this work focuses on
checking the correctness of McSema translating x86-64 binary code into LLVM IR.
Given a formal semantics and symbolic execution engine for x86-64 code and LLVM
IR, this work uses McSema to translate individual x86-64 instructions into LLVM
code and then compares the symbolic summaries obtained using those symbolic
execution engines: if these summaries are not logically equivalent, a bug is
detected in McSema. After applying this check to  x86-64 instructions, this
work detected 29 new bugs in McSema, which are all reported and acknowledged
(https://github.com/lifting-bits/remill/issues/376). 

In addition to the single-instruction validation, the work also describes a
way to validate translations of sequences of instructions. First, they use a
compositional lifter based on the validated translations to generate LLVM IR,
              and compare that the McSema lifted IR. The two versions are
              normalized using multiple standard LLVM passes and then compared
              by translating each into a graph and checking whether the graphs
              match.

## Publication
 - [Accepted PLDI'20 Paper](https://sdasgup3.github.io/files/pldi_2020.pdf)

## Evaluation w/o installation
 - [Peer Evaluated Artifacts](https://github.com/sdasgup3/PLDI20-Artifact-Evaluation)


### Checkout Repository
```C
export REPO_PATH=${HOME}/Github/ # could be any path
cd $REPO_PATH/
git clone --recursive https://github.com/sdasgup3/validating-binary-decompilation.git
git clone https://github.com/sdasgup3/compd_cache.git # required only if you wish to
                                                      # evaluate the project.
```

# Directory Structure 
 - [source: Source Code](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source)
  The above directory hosts the tools & libraries relevant for validating the
  decompilation performed by McSema. The important tools are:

    - [Compositinal-Decompiler](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/tools/decompiler)
    This is the compositional decompiler used for program level validation. For
    a given x86-64 program, the tool disassembles, using Objdump, and
    decompiles, using McSema, each x86-64 instruction and composes the
    corresponding lifted LLVM IR to create LLVM IR program.
        - Associated Library Path:
        [compositional-decompiler](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/libs/compositional-decompiler)

    - [Matcher](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/tools/matcher)
    The matcher is responsible for doing "graph isomorphic matching" on the
    LLVM data-sependence graphs derived from (1) McSema decompiled LLVM IR, and
    (2) the LLVM IR generated by the above mentioned compositional decompiler.
        - Associated Library Path:
        [llvm-graph-matching](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/libs/llvm-graph-matching)

 - [tests/single_instruction_translation_validation: Single Instruction Validation](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/tests/single_instruction_translation_validation)
 - [tests/program_translation_validation: Program Level Validation](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/tests/program_translation_validation)

## Installation
The installation goal is to build tools like [Compositinal-Decompiler](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/tools/decompiler) and  [Matcher](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/tools/matcher). The tools are build using the libraries of stoke 
and LLVM, to be installed as pre-requisites.

### Installing pre-requisites

  - Download scripts-n-docs
  ```bash
  git clone git@github.com:sdasgup3/scripts-n-docs.git
  ```

  - Install GCC/Clang
  ```bash
  [Install gcc (> ver. 6)](https://gist.github.com/zuyu/7d5682a5c75282c596449758d21db5ed)
  sudo update-alternatives --config gcc

  sudo apt-get install clang-6.0
  ```
  - Install Essentials
  ```bash
  sudo apt-get  install \
    cmake \
    z3 \
    parallel
  ```
  
  - Install LLVM-4.0.0

  ```bash
    mkdir -p ~/Install/llvm
    cd ~/Install/llvm
    ~/scripts-n-docs/scripts/bash/download-llvm.sh 4.0.0  ./ fast
    rm -rf *.xz
    mkdir llvm.4.0.0.install llvm.4.0.0.obj
    cd llvm.4.0.0.obj
    INSTALL_PREFIX=~/Install/llvm/llvm.4.0.0.install
    # cmake -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++  -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX} -DLLVM_ENABLE_ASSERTIONS=ON -DCMAKE_BUILD_TYPE="RelWithDebInfo" -DLLVM_TARGETS_TO_BUILD="host" ../llvm-4.0.0.src/
    cmake -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++  -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX} -DLLVM_ENABLE_ASSERTIONS=ON -DCMAKE_BUILD_TYPE="Release" -DLLVM_TARGETS_TO_BUILD="host" ../llvm-4.0.0.src/
    make -j64
    sudo make install
    # Keep the llvm-config path set to the version of llvm we want to use using $PATH
    # Make sure to export PATH like: export PATH=<llvm/install/dir/>:$PATH
    
    For `signal stack problems`, apply the [patch](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/docs/patches) using
    cd ${HOME}/Install/llvm/llvm-4.0.0.src
    patch -p6 < <patch file>
    
    Note: the patch is borrowed from
    https://github.com/google/sanitizers/issues/822
    https://github.com/llvm-mirror/compiler-rt/commit/8a5e425a68de4d2c80ff00a97bbcb3722a4716da
  ```

  - Install Stoke
  ```bash
    sudo apt-get install bison ccache cmake doxygen exuberant-ctags flex  g++-multilib  ghc git libantlr3c-dev libboost-dev libboost-filesystem-dev libboost-thread-dev libcln-dev libghc-regex-compat-dev libghc-regex-tdfa-dev libghc-split-dev libjsoncpp-dev python subversion libiml-dev libgmp-dev libboost-regex-dev autoconf libtool antlr pccts pkg-config
    cd ~/Github
    git clone --recursive   git@github.com:sdasgup3/stoke.git stoke-develop
    
    cd  stoke-develop/src/ext/z3
    git checkout master
    git checkout 4192c81fae01e90fd8110a00b14172be818f028b
    
    cd ~/Github/stoke-develop/src/ext/x64asm
    git remote add upstream git@github.com:sdasgup3/x64asm.git
    git fetch upstream
    git checkout working
    
    cd ~/Github/stoke-develop/
    ./configure.sh -d --no-cvc4
    cd ~/Github/stoke-develop/src/ext/x64asm
    make -j64 debug
    
    cd ~/Github/stoke-develop
    mkdir lib
    make -j64 debug
  ```
  

  - Install mcsema
  ```bash
    sudo apt-get install      git      curl      cmake      python2.7 python-pip \ 
    python-virtualenv      wget      build-essential  gcc-multilib g++-multilib  \
        libtinfo-dev      lsb-release            zlib1g-dev
    sudo dpkg --add-architecture i386
    sudo apt-get install zip zlib1g-dev:i386
    
    git clone  git@github.com:sdasgup3/mcsema.git
    cd mcsema; git checkout  develop; cd -
    
    git clone https://github.com/sdasgup3/remill.git
    cd remill; git checkout  develop_ae;
    mv ../mcsema tools
    
    ./scripts/build.sh
    cd remill-build
    sudo make install -j64
  ```


  - Install IDA
  ```bash
    mkdir -p ~/Github
    cd ~/Github
    git clone https://gitlab.engr.illinois.edu/llvm/IDA.git
    Install Ida_software/*.run
    echo "HEXRAYS_LICENSE_FILE=@presto.cs.illinois.edu" > ~/.flexlmrc
    sudo apt-get install libc6-i686:i386 libexpat1:i386 libffi6:i386 libfontconfig1:i386 libfreetype6:i386 libgcc1:i386 libglib2.0-0:i386 libice6:i386 libpcre3:i386  libsm6:i386 libstdc++6:i386 libuuid1:i386 libx11-6:i386 libxau6:i386 libxcb1:i386 libxdmcp6:i386 libxext6:i386 libxrender1:i386 zlib1g:i386 libx11-xcb1:i386 libdbus-1-3:i386 libxi6:i386 libsm6:i386 libcurl3:i386
    ~/ida-6.95/idal64
    
    ## If the ida run cannot find the google protobuf imports, add [patch](https://github.com/sdasgup3/validating-binary-decompilation/blob/master/docs/patches/mcsema_ida_import_protobuf_fix.patch) to mcsema.
  ```

   - Troubleshoot
      - [TVision error: Can not load libcurses.so](https://stackoverflow.com/questions/30098029/ida-doesnt-work-inside-screen)
      - ImportError: No module named google.protobuf
      ```
        ln -s /usr/local/lib/python2.7/dist-packages/protobuf-3.2.0-py2.7.egg/google /usr/local/lib/python2.7/dist-packages/google
      ```

### Tools Build Instructions
```bash
mkdir -p ${REPO_PATH}/validating-binary-decompilation/source/build
cd !$

cmake .. -DLLVM_ROOT=~/Install/llvm/llvm.4.0.0.install/  -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++  -DCMAKE_BUILD_TYPE="Debug" -DLLVM_ENABLE_ASSERTIONS=ON
make -j8

make check-format
make update-format
```

## Improvement/Extension Opportunities
  -  Extending the methodology to other lifters like fcd/rev.ng
  - handling the false positives on Matcher failures.
  - Efficient Caching: Right now all the instances of an instruction is cache; leads to large cahce size ~100G; Resuse similar instances
    - Reusing jmp/jcc/call is prety trivial
    - mov imm64 to ... or mov mem to ... is non trivial
