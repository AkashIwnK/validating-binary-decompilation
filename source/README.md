# Directory Overview and Structure

The current directory hosts the tools & libraries relevant for validation decompilation performed by McSema. The important tools are:

 - [Compositinal-Decompiler](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/tools/decompiler)
    This is the compositional decompiler used for program level validation. For a given x86-64 program, the tool disassembles, using Objdump, and  decompiles, using McSema, each x86-64 instruction and composes the corresponding lifted LLVM IR to create LLVM IR program.
    - Associated Library Path: [compositional-decompiler](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/libs/compositional-decompiler)

 - [Matcher](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/tools/matcher)
    The matcher is responsible for doing "graph isomorphic matching" on the LLVM def-use graphs derived from (1) McSema decompiled LLVM IR, and (2) the LLVM IR generated by the above mentioned compositional decompiler.
    - Associated Library Path:   [llvm-graph-matching](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/source/libs/llvm-graph-matching)

# Run Instructions
```bash
# Set tool binary path
TOOLDIR=${HOME}/Github/validating-binary-decompilation/source/build/bin/ # Set tool binary path

# The path to dump the output of compositional decompiler
${OURDIR}=<path>

# The path to read the binary from
${INDIR}=<path>

# The path to cache the results of single instruction decompilation using McSema.
${ARTIFACTDIR}=${HOME}/Github/validating-binary-decompilation/tests/compositional_artifacts_single_instruction_decompilation

# Running compositional decompiler
${TOOLDIR}/decompiler  --output ${OURDIR}test.proposed.ll --path ${ARTIFACTDIR} --function ${PROG} --input ${INDIR}test

# Running matcher
${TOOLDIR}/matcher --file1 ${OURDIR}test.opt.ll:${PROG} --file2 ${OURDIR}test.proposed.opt.ll:${PROG}
```

# Build Instructions
## Pre-requisite
All the tools are build using the libraries of stoke and LLVM.

### Download scripts-n-docs
```bash
git clone git@github.com:sdasgup3/scripts-n-docs.git
```

### Install GCC/Clang
```bash
Install gcc (> ver. 6)
https://gist.github.com/zuyu/7d5682a5c75282c596449758d21db5ed
sudo update-alternatives --config gcc

sudo apt-get install clang-6.0
```

### Install Essentials
```bash
sudo apt  install cmake
sudo apt-get install z3
sudo apt-get install parallel
```

### Install LLVM-4.0.0

```bash
mkdir -p ~/Install/llvm
cd ~/Install/llvm
~/scripts-n-docs/scripts/bash/download-llvm.sh 4.0.0  ./ fast
rm -rf *.xz
mkdir llvm.4.0.0.install llvm.4.0.0.obj
cd llvm.4.0.0.obj
INSTALL_PREFIX=/home/sdasgup3/Install/llvm/llvm.4.0.0.install
# cmake -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++  -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX} -DLLVM_ENABLE_ASSERTIONS=ON -DCMAKE_BUILD_TYPE="RelWithDebInfo" -DLLVM_TARGETS_TO_BUILD="host" ../llvm-4.0.0.src/
cmake -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++  -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX} -DLLVM_ENABLE_ASSERTIONS=ON -DCMAKE_BUILD_TYPE="Release" -DLLVM_TARGETS_TO_BUILD="host" ../llvm-4.0.0.src/
make -j64
sudo make install
# Keep the llvm-config path set to the version of llvm we want to use using $PATH
# Make sure to export PATH like: export PATH=<llvm/install/dir/>:$PATH

For `signal stack problems`, apply the [patch](https://github.com/sdasgup3/validating-binary-decompilation/tree/master/docs/patches) using
cd ${HOME}/Install/llvm/llvm-4.0.0.src
patch -p6 < <patch file>

Note: the patch is borrowed from
https://github.com/google/sanitizers/issues/822
https://github.com/llvm-mirror/compiler-rt/commit/8a5e425a68de4d2c80ff00a97bbcb3722a4716da
```

### Install Stoke
```bash
sudo apt-get install bison ccache cmake doxygen exuberant-ctags flex  g++-multilib  ghc git libantlr3c-dev libboost-dev libboost-filesystem-dev libboost-thread-dev libcln-dev libghc-regex-compat-dev libghc-regex-tdfa-dev libghc-split-dev libjsoncpp-dev python subversion libiml-dev libgmp-dev libboost-regex-dev autoconf libtool antlr pccts pkg-config
cd ~/Github
git clone --recursive   git@github.com:sdasgup3/stoke.git stoke-develop

cd  stoke-develop/src/ext/z3
git checkout master
git checkout 4192c81fae01e90fd8110a00b14172be818f028b

cd ~/Github/stoke-develop/src/ext/x64asm
git remote add upstream git@github.com:sdasgup3/x64asm.git
git fetch upstream
git checkout working

cd ~/Github/stoke-develop/
./configure.sh -d --no-cvc4
cd ~/Github/stoke-develop/src/ext/x64asm
make -j64 debug

cd ~/Github/stoke-develop
mkdir lib
make -j64 debug
```

### Install mcsema
```bash
sudo apt-get install      git      curl      cmake      python2.7 python-pip \ 
python-virtualenv      wget      build-essential  gcc-multilib g++-multilib  \
    libtinfo-dev      lsb-release            zlib1g-dev
sudo dpkg --add-architecture i386
sudo apt-get install zip zlib1g-dev:i386

git clone  git@github.com:sdasgup3/mcsema.git
cd mcsema; git checkout  develop; cd -

git clone https://github.com/sdasgup3/remill.git
cd remill; git checkout  develop_ae;
mv ../mcsema tools

./scripts/build.sh
cd remill-build
sudo make install -j64
```


### Install IDA
```bash
mkdir -p ~/Github
cd ~/Github
git clone https://gitlab.engr.illinois.edu/llvm/IDA.git
Install Ida_software/*.run
echo "HEXRAYS_LICENSE_FILE=@presto.cs.illinois.edu" > ~/.flexlmrc
sudo apt-get install libc6-i686:i386 libexpat1:i386 libffi6:i386 libfontconfig1:i386 libfreetype6:i386 libgcc1:i386 libglib2.0-0:i386 libice6:i386 libpcre3:i386  libsm6:i386 libstdc++6:i386 libuuid1:i386 libx11-6:i386 libxau6:i386 libxcb1:i386 libxdmcp6:i386 libxext6:i386 libxrender1:i386 zlib1g:i386 libx11-xcb1:i386 libdbus-1-3:i386 libxi6:i386 libsm6:i386 libcurl3:i386
~/ida-6.95/idal64

## If the ida run cannot find the google protobuf imports, add [patch](https://github.com/sdasgup3/validating-binary-decompilation/blob/master/docs/patches/mcsema_ida_import_protobuf_fix.patch) to mcsema.
```

#### Troubleshoot
  - [TVision error: Can not load libcurses.so](https://stackoverflow.com/questions/30098029/ida-doesnt-work-inside-screen)
  - ImportError: No module named google.protobuf
  ```
    ln -s /usr/local/lib/python2.7/dist-packages/protobuf-3.2.0-py2.7.egg/google /usr/local/lib/python2.7/dist-packages/google
  ```

### Tools Build Instructions
```bash
mkdir -p ~/Github
cd !$
git clone git@github.com:sdasgup3/validating-binary-decompilation.git
mkdir -p ${HOME}/Github/validating-binary-decompilation/source/build
cd !$

cmake .. -DLLVM_ROOT=/home/sdasgup3/Install/llvm/llvm.4.0.0.install/  -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++  -DCMAKE_BUILD_TYPE="Debug" -DLLVM_ENABLE_ASSERTIONS=ON
make -j8

make check-format
make update-format
```

### Recommended Build Practise once there is any update in any source repo
```bash

## Update/Build x64asm
cd ~/Github/stoke-develop/src/ext/x64asm
git pull upstream working
make clean; make -j64 debug

## Update/Build stoke
cd ~/Github/stoke-develop
git pull origin working
make -j64 debug

## Update/Build Matcher/compD
cd ~/Github/validating-binary-decompilation/source/build
make clean; make -j64
```



### DEPRECATED
#### Runnning the variable\_and\_basic\_block\_correspondence tool
```
validating-binary-decompilation/ir_analyzer/build/bin/variable_bb_correspondence
 [--decompiled-output <file>.ll or <file>.bc]
 [--target-function _${PROG}]
 [--init-state-function _init_var_correspondence]
 [--llvm-dfg-dot-out <file>.dot]
 [--llvm-dfg-pdf-out <file>.pdf]
 [--target binary.asm]
 [--no-fresh-mem]
 [--x86-dfg-pdf-out file.pdf]
```


#### To analyze the llvm dfg as a standalone opt pass
```
cd /home/sdasgup3/Github/validating-binary-decompilation/tests/get_sign
~/Install/llvm/llvm.4.0.0.install/bin/opt -load /home/sdasgup3/Github/validating-binary-decompilation/ir_analyzer/build/lib/LLVMvariable_correspondence.so  < get_sign_instrumented.ll   --var_corr -debug-only=variable_correspondence  -disable-output -target-function sub_660_get_sign -init-state-function sub_67b_init_var_correspondence
```

### Install mcsema
```bash
sudo apt-get install      git      curl      cmake      python2.7 python-pip python-virtualenv      wget      build-essential      gcc-multilib g++-multilib      libtinfo-dev      lsb-release            zlib1g-dev
sudo dpkg --add-architecture i386
sudo apt-get install zip zlib1g-dev:i386

git clone --depth 1 git@github.com:sdasgup3/mcsema.git
cd mcsema; git checkout  develop; cd -
export REMILL_VERSION=`cat ./mcsema/.remill_commit_id`

git clone https://github.com/trailofbits/remill.git
cd remill
git checkout -b temp ${REMILL_VERSION}
mv ../mcsema tools


./scripts/build.sh
cd remill-build
sudo make install -j64
```

