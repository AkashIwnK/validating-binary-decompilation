\begin{figure}
% \centering    
% \begin{tabular}{l@{\hskip 0.25in}|@{}l}
\begin{lstlisting}[
language=C++,
basicstyle=\scriptsize,
keywordstyle=\color{blue},
breaklines=true,
breakatwhitespace=false,
morekeywords={uintptr_t,uint64_t},
commentstyle=\color{gray},
%numbers=left,
%xleftmargin=\parindent
]
uintptr_t safe_addptr(int *of, uint64_t a, uint64_t b) {
  uintptr_t r = a + b;
  if (r < a) { *of = 1; return r; }  // "error state" 
  else { return r; } }               // "safe state" 
\end{lstlisting}
%\vspace{-5pt}
\begin{center}
{\small (a) C source code}
\end{center}
%\begin{lstlisting}[
%language=Bash,
%keywordstyle=\color{blue},
%morekeywords={movl,cmpl, jle, addl, decl, jmp, ret, sbbl, jnc},
%commentstyle=\color{gray},
%basicstyle=\scriptsize,
%%numberstyle=\tiny\color{codegray},
%breaklines=true,
%breakatwhitespace=false,
%%numbers=left,
%%xleftmargin=\parindent,
%stepnumber=1,
%escapeinside={(*}{*)}
%]
%  # Address %ebp - 8  contains 64-bit value 'a'  
%  # Adress  %ebp - 16 contains 64-bit value 'b'
%  # Let a[32:0]: lower 32 bits of 'a' 
%  #     b[32:0]: lower 32 bits of 'b'
%  movl -8(%ebp), %edx   # a[32:0] moved to %edx
%  movl -16(%ebp), %eax  # b[32:0] moved to %eax
%  addl %edx, %eax       # r = a[32:0] + b[32:0]
%  movl $0, %edx         # check if (32'0 (*$\circ$*) r) < a
%  cmpl -8(%ebp), %eax   #  (*$\circ$*): denotes concatenation
%  movl %edx, %eax
%  sbbl -4(%ebp), %eax
%  jnc L2                # true branch: "error state"
%  ...                   # set *of to 1 and %eax to r
%  jmp L3
%L2:                     # else branch: "safe state"
%  ...                   # set %eax to r
%L3: ret
%\end{lstlisting}
\begin{lstlisting}[
language=Bash,
keywordstyle=\color{blue},
morekeywords={movl,cmpl, jle, addl, decl, jmp, ret, sbbl, jnc,pushl, subl,leave},
commentstyle=\color{gray},
basicstyle=\scriptsize,
%numberstyle=\tiny\color{codegray},
breaklines=true,
breakatwhitespace=false,
%numbers=left,
%xleftmargin=\parindent,
stepnumber=1,
escapeinside={(*}{*)}
]
# Address %ebp + 12  contains 64-bit value 'a'  
# Adress  %ebp + 20 contains 64-bit value 'b'
# Let a[31:0]: lower 32 bits of 'a' 
#     b[31:0]: lower 32 bits of 'b'

pushl   %ebp
movl    %esp, %ebp
subl    $32, %esp
movl    12(%ebp), %eax
movl    %eax, -24(%ebp)   # a[31:0] stored in -24(%ebp)
movl    16(%ebp), %eax
movl    %eax, -20(%ebp)   # a[63:32] stored in -20(%ebp)
movl    20(%ebp), %eax
movl    %eax, -32(%ebp)   # b[31:0] stored in -32(%ebp)
movl    24(%ebp), %eax
movl    %eax, -28(%ebp)   # b[63:32] stored in -28(%ebp)
movl    -24(%ebp), %edx   # a[31:0] moved to %edx
movl    -32(%ebp), %eax   # b[31:0] moved to %eax
addl    %edx, %eax        # r = a[31:0] + b[31:0]
movl    %eax, -4(%ebp)    # store r at -4(%ebp)
movl    -4(%ebp), %eax
movl    $0, %edx          # check if (32'0 (*$\circ$*) r) < a
cmpl    -24(%ebp), %eax   #  (*$\circ$*): denotes concatenation
movl    %edx, %eax
sbbl    -20(%ebp), %eax
jnc     .L2               
movl    8(%ebp), %eax     # true branch: "error state"
movl    $1, (%eax)        # set *of to 1 and %eax to r
movl    -4(%ebp), %eax    # prepare return value r
jmp     .L3
.L2:                  
movl    -4(%ebp), %eax    # else branch: "safe state"; prepare return value r
.L3:
leave
ret
\end{lstlisting}
%\vspace{-5pt}
\begin{center}
{\small (b) \ISA assembly code in a 32-bit target}
\end{center}
% \multicolumn{1}{c|}{(a)} & \multicolumn{1}{c}{(b)} \\ 
% \multicolumn{1}{c|}{\footnotesize C version} & \multicolumn{1}{c}{\footnotesize Assembly version} \\ \hline
% \end{tabular}
%\vspace*{-5pt}
\caption{A security vulnerability in the HiStar kernel}
\label{fig:histar}
%\vspace*{-15pt}
\end{figure}

